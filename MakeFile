.PHONY: build up down logs cli clean test proto fmt lint test-aggressive setup-hooks

# Build all service binaries locally
build:
	go build -o bin/auth ./cmd/auth
	go build -o bin/payments ./cmd/payments
	go build -o bin/ledger ./cmd/ledger
	go build -o bin/gateway ./cmd/gateway
	go build -o bin/notifications ./cmd/notifications
	go build -o bin/micro ./cmd/cli

# Start the entire stack in Docker
up:
	docker-compose up --build -d

# Stop the stack and remove volumes
down:
	docker-compose down -v

# View logs for all services
logs:
	docker-compose logs -f

# Run the CLI tool (once built)
cli:
	./bin/micro --help

# Clean up binaries and temporary files
clean:
	rm -rf bin/
	rm -f micro gateway payments auth ledger
	rm -f mock_webhook_server.go

# Accessible packages (to avoid permission errors on macOS)
PKGS := ./cmd/auth/... ./cmd/cli/... ./cmd/connect/... ./cmd/reconciler/... ./internal/auth/... ./internal/connect/... ./internal/notification/... ./internal/payment/... ./pkg/...

# Run all tests
test:
	go test $(PKGS)

# Run aggressive tests with race detector and no caching
test-aggressive:
	go test ./... -race -count=1

# Format Go code
fmt:
	go fmt ./...

# Run golangci-lint
lint:
	golangci-lint run

# Generate Go code from Protobuf definitions
proto:
	mkdir -p proto/auth proto/ledger proto/connect
	protoc -I. -I./third_party --go_out=. --go_opt=paths=source_relative \
		--go-grpc_out=. --go-grpc_opt=paths=source_relative \
		proto/auth/auth.proto
	protoc -I. -I./third_party --go_out=. --go_opt=paths=source_relative \
		--go-grpc_out=. --go-grpc_opt=paths=source_relative \
		proto/ledger/ledger.proto
	protoc -I. -I./third_party --go_out=. --go_opt=paths=source_relative \
		--go-grpc_out=. --go-grpc_opt=paths=source_relative \
		proto/connect/connect.proto

# Set up git hooks
setup-hooks:
	git config core.hooksPath .githooks
	chmod +x .githooks/pre-commit
