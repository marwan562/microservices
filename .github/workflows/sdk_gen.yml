name: SDK Generation

on:
  push:
    branches: [main]
    paths:
      - "proto/**"
      - ".github/workflows/sdk_gen.yml"

jobs:
  generate-sdk:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v6
        with:
          go-version: "1.21" # Using a stable version for tooling

      - name: Install Protoc
        uses: arduino/setup-protoc@v3

      - name: Install protoc-gen-openapiv2
        run: go install github.com/grpc-ecosystem/grpc-gateway/v2/protoc-gen-openapiv2@latest

      - name: Generate OpenAPI Spec
        run: |
          mkdir -p generated/openapi
          # Find all proto files and generate OpenAPI specs
          # We include third_party for googleapis
          protoc -I . -I third_party \
            --openapiv2_out=logtostderr=true,allow_merge=true,merge_file_name=fintech:generated/openapi \
            $(find proto -name "*.proto")

          # The merge option creates a single 'fintech.swagger.json' if possible, or separate files.
          # Let's adjust the generation to keep it simple first or just point to the right file later.
          # With allow_merge=true, it tries to merge.

          ls -R generated/openapi

      - name: Generate Node.js SDK
        uses: openapi-generators/openapitools-generator-action@v1
        with:
          generator: typescript-axios
          openapi-file: generated/openapi/fintech.swagger.json
          command-args: -o generated/sdks/node

      - name: Generate Python SDK
        uses: openapi-generators/openapitools-generator-action@v1
        with:
          generator: python
          openapi-file: generated/openapi/fintech.swagger.json
          command-args: -o generated/sdks/python

      # In a real pipeline, we would loop over all openapi files.
      # For this repo, we demonstrate with Auth service.

      - name: Archive SDKs
        uses: actions/upload-artifact@v4
        with:
          name: generated-sdks
          path: generated/sdks
