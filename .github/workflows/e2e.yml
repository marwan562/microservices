name: E2E Integration Tests

on:
    push:
        branches: ["main"]
    pull_request:
        branches: ["main"]

jobs:
    e2e:
        name: E2E Tests
        runs-on: ubuntu-latest

        steps:
            - name: Checkout Ecosytem
              uses: actions/checkout@v4
              with:
                  path: fintech-ecosystem

            - name: Checkout Testing
              uses: actions/checkout@v4
              with:
                  repository: sapliy/fintech-testing
                  path: fintech-testing

            - name: Checkout SDK Node
              uses: actions/checkout@v4
              with:
                  repository: sapliy/fintech-sdk-node
                  path: fintech-sdk-node

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "20"
                  cache: "npm"
                  cache-dependency-path: fintech-testing/package-lock.json

            - name: Install dependencies (SDK)
              run: |
                  cd fintech-sdk-node
                  npm install

            - name: Install dependencies (Testing)
              run: |
                  cd fintech-testing
                  npm install

            - name: Start Ecosystem Stack
              run: |
                  cd fintech-ecosystem
                  docker compose up -d --build
                  echo "Waiting for services to be healthy..."
                  # The health checks in docker-compose will ensure infra is ready
                  # We still wait a bit for microservice startup
                  sleep 30

            - name: Run E2E Tests
              env:
                  GATEWAY_URL: http://localhost:8080
                  AUTH_SERVICE_URL: http://localhost:8081
              run: |
                  cd fintech-testing
                  npm test

            - name: Dump Logs on Failure
              if: failure()
              run: |
                  cd fintech-ecosystem
                  docker compose logs
